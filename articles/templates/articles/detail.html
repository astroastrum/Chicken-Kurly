{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}
<div class='container'>
  <h1 class='text-center'>게시글 상세 페이지</h1>
  <hr>
  <!-- 게시글 제목 -->
  <div class="p-2">
    제목 : {{ article.title }}
  </div>
  <hr>
  <!-- 게시글 내용 -->
  <div class="p-2">
    내용 : {{ article.content }}
  </div>
  {% if article.image %}
  <div class="my-4 mx-2 text-center">
    <img class="rounded me-3" style="width: 20rem; height: 20rem" src="{{ article.image.url }}" alt="image">
  </div>
  {% endif %}
  <hr>
  <!-- 댓글목록 -->
  {% if comments %}
  {% for comment in paginated_comments %}
  <div class='mx-2' sytle='margin: -2px;'>
    <div class='d-flex'>
      <!-- 댓글 작성자, 시간 -->
      <div class="flex-grow-1">
        <span class='fs-5 fw-semibold' style="color: #5e0080;">{{ comment.user }}</span>
        <span class='fs-6 opacity-50 fst-italic'> {{ comment.created_at }}</span>
      </div>
      <!-- 댓글 좋아요 -->
      <div>
        {% if request.user in comment.like_users.all %}
        <span><a href="{% url 'articles:c_like' comment.pk article.pk %}" style="color: red;"><i
              class="bi bi-hand-thumbs-up-fill"></i></a></span><span style="color: red;">{{ comment.like_users.count }}</span>
        {% else %}
        <span><a href="{% url 'articles:c_like' comment.pk article.pk %}" style="color: red;"><i
              class="bi bi-hand-thumbs-up"></i></a></span><span style="color: red;">{{ comment.like_users.count }}</span>
        {% endif %}
      </div>
    </div>
    <!-- 댓글 내용 -->
    <p class='fs-6'>{{ comment.content }}
      {% if request.user == comment.user %}
      <span>
        <a href="{% url 'articles:c_delete' comment.pk article.pk %}">
          <span class="fs-4" style="color: #e83c4b; display: inline-block; transform: translateY(3px);">
            <i class="bi bi-x"></i>
          </span>
        </a>
      </span>
      {% endif %}
    </p>
    <!-- 대댓글 -->
    <p>
      <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample-{{ comment.pk }}" aria-expanded="false" aria-controls="collapseExample">
        답글
      </button>
    </p>
    <div class="collapse" id="collapseExample-{{ comment.pk }}">
      <div class="card card-body">
        <div class='p-1' >
          <!-- 대댓글 목록 -->
            {% for recomment in recomments %}

                {% if recomment.comment.pk == comment.pk %}

                  {{ forloop.counter }}

                <p>
                  {{ recomment.comment.user }}
                  {{ recomment.content }}
                </p>
                <span>{{ recomment.created_at }}</span>
                {% endif %}
              
            {% endfor %}    
          <p class="text-end">
            <a href="{% url 'articles:rec_detail' comment.pk article.pk %}">더보기..</a>
          </p>
          <!-- 대댓글 입력창 -->
          <form action="{% url 'articles:rec_create' comment.pk article.pk %}" method='POST' enctype='multipart/form-data'>
            {% csrf_token %}
            {% bootstrap_form recomment_form %}
            {% bootstrap_button button_type='submit' content='글쓰기' %}
          </form>
        </div>
      </div>
      </div>
    </div>
  {% endfor %}
  {% endif %}

<!-- 댓글 페이지네이션 -->
{% if paginated_comments %}
  <ul class="pagination justify-content-center">
    <!-- 첫 페이지 -->
    {% if paginated_comments.has_previous %}
    <!-- 이전페이지가 있으면 연결(첫 페이지가 아니면) -->
    <li class="page-item">
      <a class="page-link" style="color: #5e0080; text-decoration: none;" tabindex="-1" href="?page=1">&#60;</a>
    </li>
    {% else %}
    <li class="page-item disabled">
      <a class="page-link" href="#">&#60;</a>
    </li>
    {% endif %}

    <!-- 페이지리스트 -->
    <!-- //페이지 범위를 하나씩 리턴 -->
    {% for page_number in paginated_comments.paginator.page_range %}
      {% if page_number >= paginated_comments.number|add:-2 and page_number <= paginated_comments.number|add:2 %}
          <!-- // 현재 페이지일 때는 active -->
            {% if page_number == paginated_comments.number %}
            <li class="page-item" aria-current="page">
              <a class="page-link" style="background-color: #5e0080; color: white; text-decoration: none;"
                href="?page={{ page_number }}">{{ page_number }}</a>
            </li>
            {% else %}
            <li class="page-item text-color-warning">
              <a class="page-link" style="color: #5e0080; text-decoration: none;" href="?page={{ page_number }}">{{ page_number }}</a>
            </li>
            {% endif %}
        {% endif %}
      {% endfor %}

      <!-- 다음페이지 -->
      {% if paginated_comments.has_next %}
      <li class="page-item">
        <a class="page-link" style="color: #5e0080; text-decoration: none;" href="?page={{ max_index }}">&#62;</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <a class="page-link" tabindex="-1" href="#">&#62;</a>
      </li>
      {% endif %}
  </ul>
{% else%}
<h3 class="text-center">댓글이 없습니다. ㅠㅠ</h3>
{% endif %}



    <!-- 댓글 입력 폼 -->
    <form action="{% url 'articles:c_create' article.pk %}" method="POST" id="comment-form"
      data-article-id="{{ article.pk }}">
      {% csrf_token %}
      <div class="d-flex justify-content-center">
        <div class="p-2 flex-grow-1">
          <input style="width: 100%; border: 1px solid; padding: 0.4rem 0;" type="text" placeholder="댓글을 입력해주세요"
            name="comment" id="comment" maxlength="300" required>
        </div>
        <div class="p-2">
          <button class="btn mb-1 ms-1" style="background-color: #5e0080; color: white; text-decoration: none;"
            type="submit">등록</button>
        </div>
      </div>
</div>
</div>
</form>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

  // 댓글 비동기 구현 코드 ㅠㅠ 일단 보류..
  {% comment %} const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  const commentForm = document.querySelector('#comment-form')
  commentForm.addEventListener('submit', function (event) {
    event.preventDefault()
    axios({
      method: 'post',
      url: `/articles/comment/${event.target.dataset.articleId}/`,
      headers: { 'X-CSRFToken': csrftoken },
      data: new FormData(commentForm)
    })
      .then(response => {
        console.log(response.data)

        const comments = document.querySelector('#comments')
        const div = document.createElement('div')
        div.classList.add('mx-2')
        div.style.margin = '-2px'
        const span = document.createElement('span')
        span.innerText = `${response.data.userName}`
        span.classList.add('fs-5')
        span.classList.add('fw-semibold')
        span.style.color = '#5e0080'
        const p = document.createElement('p')
        p.innerText = `${response.data.content}`
        div.appendChild(span)
        div.appendChild(p)
        comments.append(div)
        const commentInput = document.querySelector('#comment')
        commentInput.value = ''
      })
  })
  {% endcomment %}

</script>

{% endblock content %}