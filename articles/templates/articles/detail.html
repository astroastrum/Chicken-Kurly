{% extends 'base.html' %}

{% block content %}
<div class='container'>
  <h1 class='text-center'>게시글 상세 페이지</h1><hr>
  <div class="p-2">
  제목 : {{ article.title }}
  </div>
  <hr>
  <div class="p-2">
  내용 : {{ article.content }}
  </div>
  {% if article.image %}
  <div class="my-4 mx-2 text-center">
    <img class="rounded me-3" style="width: 20rem; height: 20rem" src="{{ article.image.url }}" alt="image">
  </div>
  {% endif %}
  <hr>
  <!-- 댓글창 -->
  {% if comments %}
    <div id='comments'>
      {% for comment in paginated_comments %}
        <div class='mx-2' sytle='margin: -2px;'>
          <span class='fs-6 fw-bold'>{{ comment.user }}</span><span class='fs-6 opacity-75'>  {{ comment.created_at }}</span>
          <p class='fs-6 opacity-75'>{{ comment.content }}
            {% if request.user == comment.user %}
            <span>
              <a href="{% url 'articles:c_delete' comment.pk article.pk %}">
                <span class="fs-4" style="color: #e83c4b; display: inline-block; transform: translateY(3px);">
                  <i class="bi bi-x"></i>
                </span>
              </a>
            </span>
            {% endif %}
          </p>                            
        </div>                        
      {% endfor %}
    </div>
    {% else %}
        <h4 class='text-center'>댓글이 없습니다 ㅠㅠ</h4>
    {% endif %}

    <!-- 댓글 페이지네이션 -->
    {% if paginated_comments %}
    <ul class="pagination justify-content-center">
      <!-- 첫 페이지 -->
      {% if paginated_comments.has_previous %}
        <!-- 이전페이지가 있으면 연결(첫 페이지가 아니면) -->
        <li class="page-item">
          <a class="page-link" style="color: #5e0080; text-decoration: none;" tabindex="-1" href="?page=1">&#60;</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <a class="page-link" href="#">&#60;</a>
        </li>
      {% endif %}

      <!-- 페이지리스트 -->
      <!-- //페이지 범위를 하나씩 리턴 -->
      {% for page_number in paginated_comments.paginator.page_range %}
        {% if page_number >= paginated_comments.number|add:-2 and page_number <= paginated_comments.number|add:2 %}
            <!-- // 현재 페이지일 때는 active -->
            {% if page_number == paginated_comments.number %}
              <li class="page-item" aria-current="page">
                <a class="page-link" style="background-color: #5e0080; color: white; text-decoration: none;" href="?page={{ page_number }}">{{ page_number }}</a>
              </li>
            {% else %}
              <li class="page-item text-color-warning">
                <a class="page-link" style="color: #5e0080; text-decoration: none;" href="?page={{ page_number }}">{{ page_number }}</a>
              </li>
            {% endif %}
        {% endif %}
      {% endfor %}

      <!-- 다음페이지 -->
      {% if paginated_comments.has_next %}
        <li class="page-item">
          <a class="page-link" style="color: #5e0080; text-decoration: none;" href="?page={{ max_index }}">&#62;</a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <a class="page-link" tabindex="-1" href="#">&#62;</a>
        </li>
      {% endif %}
    </ul>
  {% endif %}

    <!-- 댓글 입력 폼 -->
    <form id="comment-form" data-article-id="{{ article.pk }}">
      {% csrf_token %}
      <div class="d-flex justify-content-center">
        <div class="p-2 flex-grow-1">
          <input style="width: 100%; border: 1px solid; padding: 0.4rem 0;" type="text" placeholder="댓글을 입력해주세요" name="comment" id="comment" maxlength ="300" required>
        </div>
        <div class="p-2">
          <button class="btn mb-1 ms-1" style="background-color: #5e0080; color: white; text-decoration: none;" type="submit">등록</button>
        </div>
      </div>
    </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  const commentForm = document.querySelector('#comment-form')
  commentForm.addEventListener('submit', function(event){
    event.preventDefault()
    axios({
      method: 'post',
      url: `/articles/comment/${event.target.dataset.articleId}/`,
      headers: {'X-CSRFToken': csrftoken},
      data: new FormData(commentForm)
    })
    .then(response => {
      console.log(response.data)

      const comments = document.querySelector('#comments')
      const p = document.createElement('p')
      p.innerText = `${response.data.userName}  |  ${response.data.content}`
      const hr = document.createElement('hr')
      comments.append(p, hr)

    })

  })
</script>

{% endblock content %}